# For 2018 IL - ICP BP enablement 2018 - PART #3 - RUN as ibm
# Setup passwordless SSH for user with root access - written by Eitan Shomrai
if [ $USER = "root" ]; then echo "Do not run this script with sudo, but like this: sh $0"; exit; fi

# Parameters
  MYCLUSTER_IP=`hostname -I|cut -d " " -f1`
  PORT=2222

cat <<NOTE

 - PLEASE ENTER the user password 6! times - needed for sudo. Sorry for it...

NOTE

# Setup Passwordless SSH
  rm -rf ~/.ssh && sudo rm -rf /root/.ssh
  mkdir  ~/.ssh && sudo mkdir  /root/.ssh

  ssh-keygen -q -b 4096 -t rsa -f ~/.ssh/master.id_rsa -N "" ;
  ssh -p $PORT  -o "StrictHostKeyChecking no" -t $USER@$MYCLUSTER_IP sudo mkdir -p /root/.ssh
  sudo scp -P $PORT  -o "StrictHostKeyChecking no" ~/.ssh/master.id_rsa.pub $USER@$MYCLUSTER_IP:~/.ssh/master.id_rsa.pub
  ssh -p $PORT -o "StrictHostKeyChecking no" -t $USER@$MYCLUSTER_IP  'cat ~/.ssh/master.id_rsa.pub | sudo tee -a /root/.ssh/authorized_keys'

# Check passwordless root access:
  sudo ssh -p $PORT -o "StrictHostKeyChecking no" -i  ~/.ssh/master.id_rsa  $MYCLUSTER_IP id

cat <<QUIZ

  ---> sudo ssh -p $PORT -o "StrictHostKeyChecking no" -i  ~/.ssh/master.id_rsa  $MYCLUSTER_IP id  <--- 
QUIZ:  What the above command does?"

QUIZ

#  END PART #3
