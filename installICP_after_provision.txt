# For 2018 IL - ICP BP enablement 2018
# File: Install-script -after- provision.sh
#   by EITAN SHOMRAI
# =====> Run after provision in demo.ibmdemos.com 

# SET PARAMS
  USER=ibm
  MYCLUSTER_IP=`hostname -I|cut -d " " -f1`
  HOST_IP=`hostname -i`
  PORT=2222
  SHOST=`hostname -s`
  LHOST=`hostname -f`
  NFS_HOST=169.47.126.115
# Copy some files:
  scp -P2222 $USER@$NFS_HOST:/opt/icp/IBM_Cloud_CLI_0.6.4_amd64.tar.gz .
  scp -P2222 $USER@$NFS_HOST:/opt/icp/icp-linux-amd64 .
  scp -P2222 $USER@$NFS_HOST:/opt/icp/kubectl .

# Network setup
# Presume that Configured static IP in /etc/network/interfaces.
# Re-write /etc/hosts:
  cat <<NEW_ETC_HOSTS|sudo tee /etc/hosts
127.0.0.1  localhost.localdomain   localhost
$HOST_IP   $SHOST.demos.demoibm.com $SHOST
#127.0.1.1  $SHOST   $SHOST
$MYCLUSTER_IP  mycluster.icp
NEW_ETC_HOSTS

# Re-set the ICP cluster data:
  cd /opt/ibm-cloud-private-2.1.0
  sudo rm -rf  cluster
# Extract cluster setup files
  sudo docker run -v $(pwd):/data -e LICENSE=accept ibmcom/icp-inception:2.1.0-ee cp -r cluster /data
  sudo chown -R ibm.ibm cluster &&  cd cluster
# ??? is it neccessary ???
#  mkdir images
#  cp /opt/icp/ibm-cloud-private-x86_64-2.1.0.tar.gz images

# Change cluster files hosts, config.yaml, ssh_key
# Copy the private KEY to the cluster node:
  cp -f ~/.ssh/master.id_rsa ssh_key
# Test SSH
  sudo cp -f ~/.ssh/master.id_rsa ssh_key
  sudo ssh -p $PORT  -i  ../cluster/ssh_key root@$MYCLUSTER_IP  id
echo "QUIZ:  What the above command does?"

# hosts file
sudo cat > hosts  <<NEW_HOSTS
[master]
$MYCLUSTER_IP ansible_ssh_port=2222

[worker]
$MYCLUSTER_IP ansible_ssh_port=2222

[proxy]
$MYCLUSTER_IP ansible_ssh_port=2222

NEW_HOSTS

# config.yaml
cat >> config.yaml <<NEW_CONFIG

cluster_access_ip: $MYCLUSTER_IP

# Ansible params
ansible_user: ibm
ansible_become: true
ansible_become_password: IBMDem0s!
ansible_ssh_pass: IBMDem0s!

NEW_CONFIG

cat <<NOTE
NOTE:
If you use a non-administrator account with sudo privileges to connect to the nodes, set the ansible_user to the user name and ansible_become to true
If you run sudo with a password, you must set ansible_become_password to the value of your non-root (sudo user) password
NOTE

# Firewall...
  sudo ufw status

cat <<NOTE
*** INSTALL STARTED. You have to wait ~40 minutes ***
NOTE

date
docker run --net=host -e LICENSE=accept -v $(pwd):/installer/cluster ibmcom/icp-inception:2.1.0-ee install
cat <<NOTE
*** INSTALL ENDED ***
NOTE


