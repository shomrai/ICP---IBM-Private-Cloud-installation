# For 2018 IL - ICP BP enablement 2018
# File: Script-provision.sh
#   by EITAN SHOMRAI
# ==> Run before provision demo.ibmdemos.com Ubuntu base images
# Install ICP-EE 2.1.0
# Single node (All in one) and minimal configuration (no HA/LDAP)

# Set bash
  sed 's%home/ibm:%home/ibm:/bin/bash%' /etc/passwd > /tmp/passwd
  sudo cp /etc/passwd /etc/passwd.old && sudo cp /tmp/passwd /etc

# SET PARAMS
  USER=ibm
  MYCLUSTER_IP=`hostname -I|cut -d " " -f1`
  HOST_IP=`hostname -i`
  PORT=2222
  SHOST=`hostname -s`
  LHOST=`hostname -f`
  NFS_HOST=169.47.126.115

# Copy Software
  sudo mkdir /opt/icp && sudo chown -R ibm.ibm /opt/icp
  cd /opt/icp
  scp -P$PORT $USER@169.47.126.115:/opt/icp/* .
#                                           DOT
  /opt/icp$ du -sh *

# Install Docker ( www.ibm.com/support/knowledgecenter/SSBS6K_2.1.0/installing/install_docker.html)
  # Docker CE for Ubuntu go to: docs.docker.com/engine/installation/linux/docker-ce/ubuntu
  sudo apt-get update
  sudo apt-get remove docker docker-engine docker.io
  sudo apt-get install linux-image-extra-$(uname -r) linux-image-extra-virtual
  sudo  apt  -y  autoremove

  sudo apt-get install apt-transport-https ca-certificates curl software-properties-common
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
# Update from new repo
  sudo apt-get update

# INSTALL docker-ce:
  sudo apt-get install docker-ce
  sudo usermod -aG docker $USER
  systemctl restart docker

# TEST Docker 
  sudo docker run hello-world
# Add our user to docker group
#  su - $USER

# Save 20 minutes to load ICP images
# Change to where the ICP image was downloaded/copied.
  cd /opt/icp
  tar xf ibm-cloud-private-x86_64-2.1.0.tar.gz  -O | sudo docker load
# Check:
  sudo docker images| wc -l
# 77 images ?

# Ubuntu installations:
  sudo apt-get -y install ntp  openssh-server  python  python-pip

# Network setup assuming that static IP was setup in /etc/network/interfaces
# Re-write /etc/hosts:
  cat <<NEW_ETC_HOSTS|sudo tee /etc/hosts
127.0.0.1  localhost.localdomain   localhost
$HOST_IP   $SHOST.demos.demoibm.com $SHOST
#127.0.1.1  $SHOST   $SHOST
$MYCLUSTER_IP  mycluster.icp
NEW_ETC_HOSTS

# Ubuntu system tweaks
  sudo sysctl -w vm.max_map_count=262144
  echo "vm.max_map_count=262144" | sudo tee -a /etc/sysctl.conf

  sudo sysctl -w net.ipv4.ip_local_port_range="10240  60999"
  echo "net.ipv4.ip_local_port_range=10240 60999" | sudo tee -a /etc/sysctl.conf
  sudo sysctl -p

# Setup Passwordless SSH
  rm -rf /home/ibm/.ssh  && sudo rm -rf /root/.ssh
  mkdir  /home/ibm/.ssh && sudo mkdir  /root/.ssh

  ssh-keygen -b 4096 -t rsa -f ~/.ssh/master.id_rsa -N "" ;
  ssh -p $PORT  -t ibm@$MYCLUSTER_IP sudo mkdir -p /root/.ssh
  sudo scp -P $PORT ~/.ssh/master.id_rsa.pub ibm@$MYCLUSTER_IP:~/.ssh/master.id_rsa.pub
  ssh -p $PORT  -t ibm@$MYCLUSTER_IP  'cat ~/.ssh/master.id_rsa.pub | sudo tee -a /root/.ssh/authorized_keys'
  echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
  sudo systemctl restart sshd

# Check passwordless root access:
  sudo ssh -p $PORT -i  ~/.ssh/master.id_rsa  $MYCLUSTER_IP id
  
# Got root ? If no:
#   echo "AllowUsers ibm root" | sudo tee  -a  /etc/ssh/sshd_config
#   sudo systemctl restart sshd
#  END ------